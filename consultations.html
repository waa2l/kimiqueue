<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ø§Ø¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .main-tab { cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .main-tab.active { border-color: #1e40af; color: #1e40af; font-weight: bold; }
        
        /* Form Steps Styling */
        .step-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.3s; }
        .step-circle.active { background-color: #1e40af; color: white; }
        .step-circle.completed { background-color: #10b981; color: white; }
        .step-circle.inactive { background-color: #e5e7eb; color: #6b7280; }
        .step-line { flex: 1; height: 3px; background-color: #e5e7eb; margin: 0 10px; }
        .step-line.completed { background-color: #10b981; }

        .form-section { display: none; animation: fadeIn 0.5s; }
        .form-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .medical-checkbox:checked + div { background-color: #eff6ff; border-color: #1e40af; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-50 font-arabic">
    
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold text-primary">ğŸ¥ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ø§Ø¨</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <a href="index.html" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="profile.html" class="text-sm bg-primary text-white px-4 py-2 rounded-full hover:bg-secondary transition-colors">
                        <i class="fas fa-user ml-2"></i>Ø­Ø³Ø§Ø¨ÙŠ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="bg-white shadow mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <h1 class="text-3xl font-bold text-gray-900">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
                <p class="mt-2 text-gray-600">Ù†Ù…ÙˆØ°Ø¬ Ø·Ø¨ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ´Ø®ÙŠØµ Ø¯Ù‚ÙŠÙ‚</p>
                
                <div class="flex mt-8 space-x-8 space-x-reverse border-b">
                    <div onclick="switchTab('new')" id="tab-new" class="main-tab active pb-3 px-4">
                        <i class="fas fa-file-medical ml-2"></i>Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </div>
                    <div onclick="switchTab('history')" id="tab-history" class="main-tab pb-3 px-4 text-gray-500">
                        <i class="fas fa-notes-medical ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        
        <div id="new-consultation-section">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-4xl mx-auto">
                
                <div class="flex items-center justify-between mb-8 max-w-2xl mx-auto">
                    <div class="flex flex-col items-center relative z-10">
                        <div id="step-circle-1" class="step-circle active">1</div>
                        <span class="text-xs mt-2 font-medium">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</span>
                    </div>
                    <div id="line-1" class="step-line"></div>
                    <div class="flex flex-col items-center relative z-10">
                        <div id="step-circle-2" class="step-circle inactive">2</div>
                        <span class="text-xs mt-2 font-medium">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ</span>
                    </div>
                    <div id="line-2" class="step-line"></div>
                    <div class="flex flex-col items-center relative z-10">
                        <div id="step-circle-3" class="step-circle inactive">3</div>
                        <span class="text-xs mt-2 font-medium">Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„Ø´ÙƒÙˆÙ‰</span>
                    </div>
                </div>

                <form id="consultation-form">
                    
                    <div id="step-1" class="form-section active">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ *</label>
                                <input type="text" id="patient_name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ *</label>
                                <input type="text" id="national_id" required pattern="[0-9]{14}" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                                <input type="tel" id="phone" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù†ÙˆØ¹</label>
                                <select id="gender" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary">
                                    <option value="male">Ø°ÙƒØ±</option>
                                    <option value="female">Ø£Ù†Ø«Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø±Ø©</label>
                                <input type="number" id="family_count" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" onclick="nextStep(2)" class="bg-primary text-white px-8 py-2 rounded-lg hover:bg-secondary transition">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left mr-2"></i></button>
                        </div>
                    </div>

                    <div id="step-2" class="form-section">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ</h3>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="cursor-pointer">
                                    <input type="checkbox" name="chronic" value="diabetes" class="hidden medical-checkbox">
                                    <div class="border rounded-lg p-3 text-center hover:bg-gray-50 transition">Ø³ÙƒØ±ÙŠ</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" name="chronic" value="hypertension" class="hidden medical-checkbox">
                                    <div class="border rounded-lg p-3 text-center hover:bg-gray-50 transition">Ø¶ØºØ·</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" name="chronic" value="heart" class="hidden medical-checkbox">
                                    <div class="border rounded-lg p-3 text-center hover:bg-gray-50 transition">Ù‚Ù„Ø¨</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" name="chronic" value="asthma" class="hidden medical-checkbox">
                                    <div class="border rounded-lg p-3 text-center hover:bg-gray-50 transition">Ø±Ø¨Ùˆ</div>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="flex items-center space-x-2 space-x-reverse mb-2 font-bold cursor-pointer">
                                    <input type="checkbox" id="surgeries_check" onchange="toggleNote('surgery_notes_div', this.checked)">
                                    <span>Ù‡Ù„ Ø£Ø¬Ø±ÙŠØª Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ø±Ø§Ø­ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©ØŸ</span>
                                </label>
                                <div id="surgery_notes_div" class="hidden mt-2">
                                    <textarea id="surgery_notes" placeholder="Ø§Ø°ÙƒØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØªÙˆØ§Ø±ÙŠØ®Ù‡Ø§..." class="w-full px-3 py-2 border rounded text-sm"></textarea>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="flex items-center space-x-2 space-x-reverse mb-2 font-bold cursor-pointer">
                                    <input type="checkbox" id="allergies_check" onchange="toggleNote('allergy_notes_div', this.checked)">
                                    <span>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø³ÙŠØ© (Ø£Ø¯ÙˆÙŠØ©/Ø·Ø¹Ø§Ù…)ØŸ</span>
                                </label>
                                <div id="allergy_notes_div" class="hidden mt-2">
                                    <textarea id="allergy_notes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©..." class="w-full px-3 py-2 border rounded text-sm"></textarea>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="flex items-center space-x-2 space-x-reverse mb-2 font-bold cursor-pointer">
                                    <input type="checkbox" id="medications_check" onchange="toggleNote('medication_notes_div', this.checked)">
                                    <span>Ù‡Ù„ ØªØªÙ†Ø§ÙˆÙ„ Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ</span>
                                </label>
                                <div id="medication_notes_div" class="hidden mt-2">
                                    <textarea id="medication_notes" placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª..." class="w-full px-3 py-2 border rounded text-sm"></textarea>
                                </div>
                            </div>

                            <div class="bg-pink-50 p-4 rounded-lg" id="female-section">
                                <p class="text-sm font-bold text-pink-700 mb-2">Ø®Ø§Øµ Ø¨Ø§Ù„Ø¥Ù†Ø§Ø«</p>
                                <div class="flex gap-4">
                                    <label class="flex items-center space-x-2 space-x-reverse">
                                        <input type="checkbox" id="pregnancy"> <span>Ø­Ù…Ù„</span>
                                    </label>
                                    <label class="flex items-center space-x-2 space-x-reverse">
                                        <input type="checkbox" id="breastfeeding"> <span>Ø±Ø¶Ø§Ø¹Ø©</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-between">
                            <button type="button" onclick="nextStep(1)" class="bg-gray-500 text-white px-8 py-2 rounded-lg hover:bg-gray-600 transition">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                            <button type="button" onclick="nextStep(3)" class="bg-primary text-white px-8 py-2 rounded-lg hover:bg-secondary transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        </div>
                    </div>

                    <div id="step-3" class="form-section">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© ÙˆØ§Ù„Ø´ÙƒÙˆÙ‰</h3>
                        
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ø§Ù„ÙˆØ²Ù† (kg)</label>
                                <input type="number" id="weight" step="0.1" class="w-full px-2 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ø§Ù„Ø·ÙˆÙ„ (cm)</label>
                                <input type="number" id="height" class="w-full px-2 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ø§Ù„Ø­Ø±Ø§Ø±Ø© (C)</label>
                                <input type="number" id="temperature" step="0.1" class="w-full px-2 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ø¶ØºØ· Ø§Ù„Ø¯Ù…</label>
                                <input type="text" id="blood_pressure" placeholder="120/80" class="w-full px-2 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Ø§Ù„Ù†Ø¨Ø¶</label>
                                <input type="number" id="pulse" class="w-full px-2 py-2 border rounded">
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ *</label>
                            <select id="specialty" required class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ</option>
                                <option value="Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©">Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©</option>
                                <option value="Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ©">Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ©</option>
                                <option value="Ø§Ù„Ø£Ø·ÙØ§Ù„">Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
                                <option value="Ø§Ù„Ù†Ø³Ø§Ø¡">Ø§Ù„Ù†Ø³Ø§Ø¡</option>
                                <option value="Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                                <option value="Ø§Ù„Ø¬Ù„Ø¯ÙŠØ©">Ø§Ù„Ø¬Ù„Ø¯ÙŠØ©</option>
                            </select>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© *</label>
                            <textarea id="complaint" required rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary" placeholder="Ù…Ù… ØªØ´ÙƒÙˆ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯ØŸ"></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…ØµØ§Ø­Ø¨Ø©</label>
                            <textarea id="symptoms" rows="2" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-primary" placeholder="Ø£ÙŠ Ø£Ø¹Ø±Ø§Ø¶ Ø£Ø®Ø±Ù‰ (ØµØ¯Ø§Ø¹ØŒ Ø­Ø±Ø§Ø±Ø©ØŒ Ø¥Ù„Ø®)..."></textarea>
                        </div>

                        <div class="mt-8 flex justify-between">
                            <button type="button" onclick="nextStep(2)" class="bg-gray-500 text-white px-8 py-2 rounded-lg hover:bg-gray-600 transition">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                            <button type="submit" class="bg-success text-white px-8 py-2 rounded-lg hover:bg-green-600 transition font-bold shadow-lg">
                                <i class="fas fa-paper-plane ml-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>

        <div id="history-section" class="hidden">
            <div id="login-warning" class="hidden text-center py-12 bg-white rounded-lg shadow-lg">
                <i class="fas fa-lock text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-700">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                <p class="text-gray-500 mb-4">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ø³ØªØ´Ø§Ø±Ø§ØªÙƒ</p>
                <button onclick="window.supabaseHelpers.signInWithGoogle()" class="bg-primary text-white px-6 py-2 rounded-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>

            <div id="consultations-list" class="space-y-4 max-w-4xl mx-auto">
                <div class="text-center text-gray-500 py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>

        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
                <div class="text-success text-6xl mb-4"><i class="fas fa-check-circle"></i></div>
                <h3 class="text-2xl font-bold mb-4">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p class="text-gray-600 mb-6">Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                    <span id="new-consultation-number" class="text-3xl font-mono font-bold text-primary"></span>
                </div>
                <button onclick="location.reload()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary">Ø­Ø³Ù†Ø§Ù‹</button>
            </div>
        </div>

    </div>

    <script src="supabaseClient.js"></script>
    <script>
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©
        function checkReady() {
            return new Promise(resolve => {
                if (window.supabaseHelpers) resolve();
                else setTimeout(() => checkReady().then(resolve), 100);
            });
        }

        // --- Form Navigation ---
        function nextStep(step) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
            if (step === 2) {
                const requiredIds = ['patient_name', 'national_id', 'phone'];
                for (let id of requiredIds) {
                    if (!document.getElementById(id).value) {
                        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (*) ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©');
                        return;
                    }
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
            for(let i=1; i<=3; i++) {
                const circle = document.getElementById(`step-circle-${i}`);
                const line = document.getElementById(`line-${i-1}`);
                
                if (i < step) {
                    circle.classList.remove('active', 'inactive');
                    circle.classList.add('completed');
                    circle.innerHTML = '<i class="fas fa-check"></i>';
                    if(line) line.classList.add('completed');
                } else if (i === step) {
                    circle.classList.remove('completed', 'inactive');
                    circle.classList.add('active');
                    circle.textContent = i;
                    if(line) line.classList.add('completed');
                } else {
                    circle.classList.remove('active', 'completed');
                    circle.classList.add('inactive');
                    circle.textContent = i;
                    if(line) line.classList.remove('completed');
                }
            }
        }

        function toggleNote(divId, isChecked) {
            const div = document.getElementById(divId);
            if (isChecked) div.classList.remove('hidden');
            else div.classList.add('hidden');
        }

        function switchTab(tab) {
            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.main-tab').forEach(t => {
                t.classList.remove('active', 'text-gray-500');
                t.classList.add('text-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');

            if (tab === 'new') {
                document.getElementById('new-consultation-section').classList.remove('hidden');
                document.getElementById('history-section').classList.add('hidden');
            } else {
                document.getElementById('new-consultation-section').classList.add('hidden');
                document.getElementById('history-section').classList.remove('hidden');
                loadUserConsultations();
            }
        }

        // --- Form Submission ---
        document.getElementById('consultation-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            await checkReady();

            // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©
            const chronic = [];
            document.querySelectorAll('input[name="chronic"]:checked').forEach(c => chronic.push(c.value));

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„
            const data = {
                patient_name: document.getElementById('patient_name').value,
                national_id: document.getElementById('national_id').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                gender: document.getElementById('gender').value,
                family_count: document.getElementById('family_count').value || 0,
                
                chronic_diseases: chronic, // Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡ ÙƒÙ€ JSONB
                
                surgeries: document.getElementById('surgeries_check').checked,
                surgery_notes: document.getElementById('surgery_notes').value,
                
                allergies: document.getElementById('allergies_check').checked,
                allergy_notes: document.getElementById('allergy_notes').value,
                
                medications: document.getElementById('medications_check').checked,
                medication_notes: document.getElementById('medication_notes').value,
                
                pregnancy: document.getElementById('pregnancy').checked,
                breastfeeding: document.getElementById('breastfeeding').checked,
                
                weight: document.getElementById('weight').value || null,
                height: document.getElementById('height').value || null,
                temperature: document.getElementById('temperature').value || null,
                blood_pressure: document.getElementById('blood_pressure').value,
                pulse: document.getElementById('pulse').value || null,
                
                specialty: document.getElementById('specialty').value,
                complaint: document.getElementById('complaint').value,
                symptoms: document.getElementById('symptoms').value,
                
                // System Fields
                consultation_number: `CON${Math.floor(Math.random() * 1000000)}`,
                status: 'pending'
            };

            const result = await window.supabaseHelpers.addConsultation(data);

            if (result) {
                document.getElementById('new-consultation-number').textContent = data.consultation_number;
                document.getElementById('success-modal').classList.remove('hidden');
                document.getElementById('success-modal').classList.add('flex');
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
                btn.disabled = false;
                btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©';
            }
        });

        // --- Load History ---
        async function loadUserConsultations() {
            await checkReady();
            const user = await window.supabaseHelpers.getCurrentUser();
            
            if (!user) {
                document.getElementById('login-warning').classList.remove('hidden');
                document.getElementById('consultations-list').classList.add('hidden');
                return;
            }

            document.getElementById('login-warning').classList.add('hidden');
            document.getElementById('consultations-list').classList.remove('hidden');

            const consultations = await window.supabaseHelpers.getMyConsultations(user.id);
            const container = document.getElementById('consultations-list');
            container.innerHTML = '';

            if (consultations.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 border rounded bg-white">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
                return;
            }

            consultations.forEach(c => {
                const isReplied = c.status === 'completed'; // Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ status Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙØ§Ù‹
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ doctor_reply Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† doctor_response
                const replyText = c.doctor_reply; 
                
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-sm border border-gray-200 transition hover:shadow-md';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-xs text-gray-400 font-mono mb-1">#${c.consultation_number || '---'}</div>
                            <h3 class="font-bold text-lg text-gray-800">${c.specialty}</h3>
                            <div class="text-xs text-gray-500">${new Date(c.created_at).toLocaleDateString('ar-EG')}</div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${replyText ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${replyText ? 'ØªÙ… Ø§Ù„Ø±Ø¯' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 font-semibold mb-1">Ø§Ù„Ø´ÙƒÙˆÙ‰:</p>
                        <p class="text-gray-800 bg-gray-50 p-3 rounded text-sm">${c.complaint}</p>
                    </div>

                    ${replyText ? `
                        <div class="border-t pt-4 mt-4">
                            <div class="flex items-center mb-2 text-green-700 font-bold text-sm">
                                <i class="fas fa-user-md ml-2"></i> Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨:
                            </div>
                            <div class="bg-green-50 border border-green-100 p-4 rounded text-gray-800 text-sm leading-relaxed whitespace-pre-line">
                                ${replyText}
                            </div>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }
    </script>
</body>
</html>
