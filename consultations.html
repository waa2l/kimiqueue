<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ø§Ø¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .main-tab { cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .main-tab.active { border-color: #1e40af; color: #1e40af; font-weight: bold; }
        .consultation-card { transition: all 0.2s; }
        .consultation-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-50 font-arabic">
    
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold text-primary">ğŸ¥ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ø§Ø¨</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <a href="index.html" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="profile.html" class="text-sm bg-primary text-white px-4 py-2 rounded-full hover:bg-secondary transition-colors">
                        <i class="fas fa-user ml-2"></i>Ø­Ø³Ø§Ø¨ÙŠ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="bg-white shadow mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <h1 class="text-3xl font-bold text-gray-900">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
                <p class="mt-2 text-gray-600">Ø§Ø·Ù„Ø¨ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ© Ø£Ùˆ ØªØ§Ø¨Ø¹ Ø³Ø¬Ù„ Ø§Ø³ØªØ´Ø§Ø±Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
                
                <div class="flex mt-8 space-x-8 space-x-reverse border-b">
                    <div onclick="switchTab('new')" id="tab-new" class="main-tab active pb-3 px-4">
                        <i class="fas fa-plus-circle ml-2"></i>Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </div>
                    <div onclick="switchTab('history')" id="tab-history" class="main-tab pb-3 px-4 text-gray-500">
                        <i class="fas fa-history ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        
        <div id="new-consultation-section">
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl mx-auto">
                <div class="border-b pb-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</h2>
                    <p class="text-sm text-gray-500">Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø®ØªØµ Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª</p>
                </div>

                <form id="consultation-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                            <input type="text" id="patient-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                            <select id="specialty" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ</option>
                                <option value="Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©">Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©</option>
                                <option value="Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ©">Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ©</option>
                                <option value="Ø§Ù„Ø£Ø·ÙØ§Ù„">Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
                                <option value="Ø§Ù„Ù†Ø³Ø§Ø¡">Ø§Ù„Ù†Ø³Ø§Ø¡</option>
                                <option value="Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                                <option value="Ø§Ù„Ø¬Ù„Ø¯ÙŠØ©">Ø§Ù„Ø¬Ù„Ø¯ÙŠØ©</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø´ÙƒÙˆÙ‰ / Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</label>
                        <textarea id="complaint" required rows="5" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" placeholder="Ø§Ø´Ø±Ø­ Ù…Ø§ ØªØ´Ø¹Ø± Ø¨Ù‡ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-secondary font-semibold shadow-md transition-all">
                            <i class="fas fa-paper-plane ml-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="history-section" class="hidden">
            
            <div id="guest-view" class="hidden text-center py-12 bg-white rounded-lg shadow-lg">
                <div class="text-6xl text-gray-300 mb-4"><i class="fas fa-lock"></i></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                <p class="text-gray-600 mb-6">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªØ´Ø§Ø±Ø§ØªÙƒ ÙˆØ±Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>
                <div class="space-x-4 space-x-reverse">
                    <button onclick="window.supabaseHelpers.signInWithGoogle()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary">
                        <i class="fab fa-google ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                    <div class="mt-8 pt-8 border-t max-w-md mx-auto">
                        <p class="text-sm text-gray-500 mb-3">Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© (Ù„Ù„Ø¶ÙŠÙˆÙ)</p>
                        <div class="flex gap-2">
                            <input type="text" id="search-number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© (Ù…Ø«Ø§Ù„: CON123456)" class="flex-1 px-4 py-2 border rounded-lg">
                            <button onclick="searchByNumber()" class="bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200">Ø¨Ø­Ø«</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="user-view" class="hidden max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Ø³Ø¬Ù„ Ø§Ø³ØªØ´Ø§Ø±Ø§ØªÙŠ</h2>
                    <span id="user-welcome" class="text-sm text-gray-500"></span>
                </div>
                
                <div id="consultations-list" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </div>
                </div>
            </div>

            <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-2xl">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</h3>
                        <button onclick="document.getElementById('result-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                    <div id="result-content"></div>
                </div>
            </div>

        </div>

        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
                <div class="text-success text-6xl mb-4"><i class="fas fa-check-circle"></i></div>
                <h3 class="text-2xl font-bold mb-4">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p class="text-gray-600 mb-6">ØªÙ… Ø­ÙØ¸ Ø§Ø³ØªØ´Ø§Ø±ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­</p>
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100">
                    <div class="text-sm text-gray-600 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</div>
                    <div class="text-3xl font-bold text-primary tracking-wider" id="new-consultation-number">---</div>
                </div>
                <button onclick="location.reload()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary">Ø­Ø³Ù†Ø§Ù‹</button>
            </div>
        </div>

    </div>

    <script src="supabaseClient.js"></script>
    <script>
        // Supabase Ready Check
        function checkReady() {
            return new Promise(resolve => {
                if (window.supabaseHelpers) resolve();
                else setTimeout(() => checkReady().then(resolve), 100);
            });
        }

        // --- Tabs Logic ---
        function switchTab(tabName) {
            // Update UI
            document.querySelectorAll('.main-tab').forEach(el => {
                el.classList.remove('active', 'text-gray-500');
                el.classList.add('text-gray-500');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-500');

            // Show Sections
            if (tabName === 'new') {
                document.getElementById('new-consultation-section').classList.remove('hidden');
                document.getElementById('history-section').classList.add('hidden');
            } else {
                document.getElementById('new-consultation-section').classList.add('hidden');
                document.getElementById('history-section').classList.remove('hidden');
                loadHistory(); // Load data when tab is opened
            }
        }

        // --- New Consultation Logic ---
        document.getElementById('consultation-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            await checkReady();

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const consultationData = {
                patient_name: document.getElementById('patient-name').value,
                specialty: document.getElementById('specialty').value,
                complaint: document.getElementById('complaint').value,
                
                // System Fields (Automatic)
                consultation_number: `CON${Math.floor(Math.random() * 100000) + 100000}`,
                status: 'pending',
                // doctor_id: null (default in db)
                // doctor_response: null (default in db)
                // user_id: will be added by supabaseHelpers.addConsultation if logged in
            };

            const result = await window.supabaseHelpers.addConsultation(consultationData);

            if (result) {
                document.getElementById('new-consultation-number').textContent = consultationData.consultation_number;
                document.getElementById('success-modal').classList.remove('hidden');
                document.getElementById('success-modal').classList.add('flex');
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane ml-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©';
            }
        });

        // --- History Logic ---
        async function loadHistory() {
            await checkReady();
            const user = await window.supabaseHelpers.getCurrentUser();

            if (user) {
                // Logged In
                document.getElementById('guest-view').classList.add('hidden');
                document.getElementById('user-view').classList.remove('hidden');
                document.getElementById('user-welcome').textContent = user.email;

                const consultations = await window.supabaseHelpers.getMyConsultations(user.id);
                renderConsultationsList(consultations);
            } else {
                // Guest
                document.getElementById('guest-view').classList.remove('hidden');
                document.getElementById('user-view').classList.add('hidden');
            }
        }

        function renderConsultationsList(data) {
            const container = document.getElementById('consultations-list');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-lg border border-dashed border-gray-300">
                        <i class="fas fa-file-medical-alt text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>
                    </div>
                `;
                return;
            }

            data.forEach(item => {
                const isReplied = item.status === 'completed';
                const statusBadge = isReplied 
                    ? `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">ØªÙ… Ø§Ù„Ø±Ø¯</span>`
                    : `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>`;

                const card = document.createElement('div');
                card.className = 'consultation-card bg-white p-5 rounded-lg border border-gray-200 shadow-sm';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-xs text-gray-400">#${item.consultation_number}</span>
                            <h4 class="font-bold text-gray-800 text-lg">${item.specialty}</h4>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded text-gray-700 text-sm mb-3">
                        <span class="font-semibold block mb-1">Ø§Ù„Ø´ÙƒÙˆÙ‰:</span>
                        ${item.complaint}
                    </div>

                    ${isReplied ? `
                        <div class="mt-4 border-t pt-3">
                            <div class="flex items-center text-green-700 font-bold mb-2">
                                <i class="fas fa-user-md ml-2"></i>
                                Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ (${item.doctors?.name || 'Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø±ÙƒØ²'}):
                            </div>
                            <p class="text-gray-800 text-sm leading-relaxed bg-green-50 p-3 rounded border border-green-100">
                                ${item.doctor_response}
                            </p>
                        </div>
                    ` : `
                        <div class="text-xs text-gray-400 mt-2 flex items-center">
                            <i class="far fa-clock ml-1"></i>
                            ${new Date(item.created_at).toLocaleDateString('ar-EG')}
                        </div>
                    `}
                `;
                container.appendChild(card);
            });
        }

        // --- Guest Search Logic ---
        async function searchByNumber() {
            const num = document.getElementById('search-number').value.trim();
            if (!num) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©');

            await checkReady();
            const result = await window.supabaseHelpers.getConsultationByNumber(num);

            if (result) {
                const isReplied = result.status === 'completed';
                const html = `
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-bold">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                            <span class="${isReplied ? 'text-green-600' : 'text-yellow-600'} font-bold">
                                ${isReplied ? 'ØªÙ… Ø§Ù„Ø±Ø¯' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}
                            </span>
                        </div>
                        <div>
                            <span class="block text-gray-500 text-sm">Ø§Ù„Ù…Ø±ÙŠØ¶:</span>
                            <span class="font-medium">${result.patient_name}</span>
                        </div>
                        <div>
                            <span class="block text-gray-500 text-sm">Ø§Ù„Ø´ÙƒÙˆÙ‰:</span>
                            <p class="bg-gray-50 p-2 rounded text-sm">${result.complaint}</p>
                        </div>
                        ${isReplied ? `
                            <div class="bg-green-50 p-3 rounded border border-green-200">
                                <span class="block text-green-700 font-bold text-sm mb-1">Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨:</span>
                                <p class="text-gray-800">${result.doctor_response}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                document.getElementById('result-content').innerHTML = html;
                document.getElementById('result-modal').classList.remove('hidden');
                document.getElementById('result-modal').classList.add('flex');
            } else {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
            }
        }
    </script>
</body>
</html>
