<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .nav-item { cursor: pointer; padding: 10px 20px; border-radius: 8px; transition: all 0.2s; color: #4b5563; }
        .nav-item:hover { background-color: #e5e7eb; }
        .nav-item.active { background-color: #1e40af; color: white; font-weight: bold; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .detail-label { color: #6b7280; font-size: 0.875rem; }
        .detail-value { font-weight: 600; color: #1f2937; }
    </style>
</head>
<body>

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-primary">ğŸ‘¨â€âš•ï¸ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</h1>
                <span id="doc-name" class="text-sm bg-blue-50 text-blue-700 px-3 py-1 rounded-full"></span>
            </div>
            <button onclick="logout()" class="text-red-500 hover:text-red-700 font-medium">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-gray-900/50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h2>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-3 border rounded" required>
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 border rounded" required>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded font-bold hover:bg-blue-700">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <div id="portal-content" class="max-w-7xl mx-auto px-4 py-8 hidden">
        
        <div class="flex flex-wrap gap-2 mb-6 bg-white p-2 rounded-lg shadow-sm">
            <div onclick="switchTab('dashboard')" id="tab-dashboard" class="nav-item active">
                <i class="fas fa-inbox ml-2"></i>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
            </div>
            <div onclick="switchTab('history')" id="tab-history" class="nav-item">
                <i class="fas fa-history ml-2"></i>Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯
            </div>
            <div onclick="switchTab('attendance')" id="tab-attendance" class="nav-item">
                <i class="fas fa-clock ml-2"></i>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù
            </div>
            <div onclick="switchTab('leaves')" id="tab-leaves" class="nav-item">
                <i class="fas fa-calendar-minus ml-2"></i>Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª
            </div>
        </div>

        <div id="sec-dashboard" class="content-section active">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù…ÙØªÙˆØ­Ø© (ØªØ®ØµØµÙƒ)
                </h2>
                <div id="pending-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </div>

        <div id="sec-history" class="content-section">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4 text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ Ø±Ø¯Ø¯Øª Ø¹Ù„ÙŠÙ‡Ø§</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 text-gray-700">
                            <tr>
                                <th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</th>
                                <th class="p-3">Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                                <th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯</th>
                                <th class="p-3">Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø¯</th>
                                <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-attendance" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <h3 class="font-bold text-gray-700 mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="space-y-3">
                        <button onclick="checkInAction()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
                        <button onclick="checkOutAction()" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù</button>
                    </div>
                    <p id="att-status" class="mt-3 text-sm text-gray-500"></p>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-gray-700 mb-4">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                    <div class="overflow-y-auto max-h-64">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-2">Ø¯Ø®ÙˆÙ„</th>
                                    <th class="p-2">Ø®Ø±ÙˆØ¬</th>
                                    <th class="p-2">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="att-table-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-leaves" class="content-section">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="font-bold mb-4">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯</h3>
                <form id="leave-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="text-xs block mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select id="leave-type" class="w-full p-2 border rounded">
                            <option>Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©</option>
                            <option>Ù…Ø±Ø¶ÙŠØ©</option>
                            <option>Ø¹Ø§Ø±Ø¶Ø©</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs block mb-1">Ù…Ù†</label>
                        <input type="date" id="leave-start" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="text-xs block mb-1">Ø¥Ù„Ù‰</label>
                        <input type="date" id="leave-end" class="w-full p-2 border rounded" required>
                    </div>
                    <button type="submit" class="bg-primary text-white py-2 rounded">ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨</button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-bold mb-4">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
                <table class="w-full text-sm text-right">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th class="p-3">Ù…Ù†</th>
                            <th class="p-3">Ø¥Ù„Ù‰</th>
                            <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="leaves-table-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="reply-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col shadow-2xl">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-primary">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© ÙˆØ§Ù„Ø±Ø¯</h3>
                    <p class="text-sm text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©: <span id="modal-consultation-number" class="font-mono font-bold"></span></p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="detail-label">Ø§Ù„Ø§Ø³Ù…:</span> <div class="detail-value" id="modal-patient-name"></div></div>
                            <div><span class="detail-label">Ø§Ù„Ù†ÙˆØ¹:</span> <div class="detail-value" id="modal-gender"></div></div>
                            <div><span class="detail-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <div class="detail-value" id="modal-phone"></div></div>
                            <div><span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <div class="detail-value" id="modal-date"></div></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</h4>
                        <div class="grid grid-cols-3 gap-3 text-center text-sm">
                            <div class="bg-blue-50 p-2 rounded"><div class="text-gray-500">Ø§Ù„Ø¶ØºØ·</div><div class="font-bold text-blue-700" id="modal-bp">--</div></div>
                            <div class="bg-red-50 p-2 rounded"><div class="text-gray-500">Ø§Ù„Ù†Ø¨Ø¶</div><div class="font-bold text-red-700" id="modal-pulse">--</div></div>
                            <div class="bg-yellow-50 p-2 rounded"><div class="text-gray-500">Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div><div class="font-bold text-yellow-700" id="modal-temp">--</div></div>
                            <div class="bg-gray-50 p-2 rounded"><div class="text-gray-500">Ø§Ù„ÙˆØ²Ù†</div><div class="font-bold" id="modal-weight">--</div></div>
                            <div class="bg-gray-50 p-2 rounded"><div class="text-gray-500">Ø§Ù„Ø·ÙˆÙ„</div><div class="font-bold" id="modal-height">--</div></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border md:col-span-2">
                        <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><span class="detail-label">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©:</span> <div class="detail-value text-red-600" id="modal-chronic"></div></div>
                            <div><span class="detail-label">Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:</span> <div class="detail-value text-red-600" id="modal-allergies"></div></div>
                            <div><span class="detail-label">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</span> <div class="detail-value" id="modal-surgeries"></div></div>
                            <div><span class="detail-label">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> <div class="detail-value" id="modal-meds"></div></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border md:col-span-2 border-l-4 border-l-primary">
                        <h4 class="font-bold text-gray-800 mb-2">Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
                        <p class="text-gray-700 bg-gray-50 p-3 rounded" id="modal-complaint"></p>
                        <h4 class="font-bold text-gray-800 mt-3 mb-2">Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…ØµØ§Ø­Ø¨Ø©</h4>
                        <p class="text-gray-700 bg-gray-50 p-3 rounded" id="modal-symptoms"></p>
                    </div>

                </div>
            </div>

            <div class="bg-white px-6 py-4 border-t">
                <form id="reply-form">
                    <label class="block text-gray-700 font-bold mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠ:</label>
                    <textarea id="doctor-reply" rows="4" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary mb-3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­..." required></textarea>
                    
                    <div class="flex space-x-3 space-x-reverse">
                        <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-secondary font-bold">
                            <i class="fas fa-paper-plane ml-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
                        </button>
                        <button type="button" onclick="closeModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        let currentDoc = null;
        let selectedConsultationId = null;

        function checkReady() { return new Promise(r => window.supabaseHelpers ? r() : setTimeout(() => checkReady().then(r), 100)); }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await checkReady();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            const docs = await window.supabaseHelpers.getDoctors();
            const doc = docs.find(d => d.email === email && d.password === pass);

            if(doc) {
                currentDoc = doc;
                localStorage.setItem('doctor', JSON.stringify(doc));
                showPortal();
            } else {
                alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
            }
        });

        function showPortal() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('portal-content').classList.remove('hidden');
            document.getElementById('doc-name').textContent = `Ø¯. ${currentDoc.name} (${currentDoc.specialty})`;
            loadDashboard();
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`sec-${tab}`).classList.add('active');

            if(tab === 'dashboard') loadDashboard();
            if(tab === 'history') loadHistory();
            if(tab === 'attendance') loadAttendance();
            if(tab === 'leaves') loadLeaves();
        }

        async function loadDashboard() {
            const list = document.getElementById('pending-list');
            list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            
            const consultations = await window.supabaseHelpers.getPendingConsultationsBySpecialty(currentDoc.specialty);
            
            if(consultations.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
                return;
            }

            list.innerHTML = '';
            consultations.forEach(c => {
                const div = document.createElement('div');
                div.className = 'bg-white border rounded p-4 flex justify-between items-center hover:shadow-md transition';
                div.innerHTML = `
                    <div>
                        <h4 class="font-bold">${c.patient_name}</h4>
                        <p class="text-sm text-gray-500 truncate w-64">${c.complaint}</p>
                        <span class="text-xs text-gray-400">${new Date(c.created_at).toLocaleDateString('ar-EG')}</span>
                    </div>
                    <button onclick="openReply('${c.id}')" class="bg-blue-100 text-blue-700 px-4 py-2 rounded text-sm hover:bg-blue-200">Ø±Ø¯</button>
                `;
                list.appendChild(div);
            });
        }

        async function loadHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">...</td></tr>';
            
            const history = await window.supabaseHelpers.getDoctorHistory(currentDoc.id);
            tbody.innerHTML = '';

            history.forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 font-mono text-gray-500">${h.consultation_number || '-'}</td>
                    <td class="p-3 font-bold">${h.patient_name}</td>
                    <td class="p-3">${new Date(h.updated_at).toLocaleDateString('ar-EG')}</td>
                    <td class="p-3 text-gray-500 truncate max-w-xs">${h.doctor_reply || ''}</td>
                    <td class="p-3"><span class="bg-green-100 text-green-700 px-2 rounded text-xs">Ù…ÙƒØªÙ…Ù„Ø©</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        let currentConsultation = null;
        async function openReply(id) {
            const all = await window.supabaseHelpers.getPendingConsultationsBySpecialty(currentDoc.specialty);
            currentConsultation = all.find(c => c.id == id);
            
            document.getElementById('modal-consultation-number').textContent = currentConsultation.consultation_number;
            document.getElementById('modal-patient-name').textContent = currentConsultation.patient_name;
            document.getElementById('modal-gender').textContent = currentConsultation.gender;
            document.getElementById('modal-phone').textContent = currentConsultation.phone;
            document.getElementById('modal-date').textContent = new Date(currentConsultation.created_at).toLocaleDateString('ar-EG');
            
            document.getElementById('modal-bp').textContent = currentConsultation.blood_pressure || '--';
            document.getElementById('modal-pulse').textContent = currentConsultation.pulse || '--';
            document.getElementById('modal-temp').textContent = currentConsultation.temperature || '--';
            document.getElementById('modal-weight').textContent = currentConsultation.weight || '--';
            document.getElementById('modal-height').textContent = currentConsultation.height || '--';

            // Parse Array/JSON fields safely
            let chronic = currentConsultation.chronic_diseases;
            if (typeof chronic === 'string') { // handle possible parsing formats
                 try { chronic = JSON.parse(chronic); } catch(e) { chronic = [chronic]; }
            }
            document.getElementById('modal-chronic').textContent = (Array.isArray(chronic) && chronic.length) ? chronic.join(', ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            
            document.getElementById('modal-allergies').textContent = currentConsultation.drug_allergies ? (currentConsultation.allergy_notes || 'Ù†Ø¹Ù…') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            document.getElementById('modal-surgeries').textContent = currentConsultation.previous_surgeries ? (currentConsultation.surgery_notes || 'Ù†Ø¹Ù…') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            document.getElementById('modal-meds').textContent = currentConsultation.current_medications ? (currentConsultation.medication_notes || 'Ù†Ø¹Ù…') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

            document.getElementById('modal-complaint').textContent = currentConsultation.complaint;
            document.getElementById('modal-symptoms').textContent = currentConsultation.symptoms || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

            document.getElementById('reply-modal').classList.remove('hidden');
            document.getElementById('reply-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('reply-modal').classList.add('hidden');
            document.getElementById('reply-modal').classList.remove('flex');
        }

        document.getElementById('reply-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const reply = document.getElementById('doctor-reply').value;
            if(!reply) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯');

            const success = await window.supabaseHelpers.updateConsultation(currentConsultation.id, {
                doctor_reply: reply,
                doctor_id: currentDoc.id,
                status: 'completed',
                updated_at: new Date().toISOString()
            });

            if(success) {
                alert('ØªÙ… Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                closeModal();
                loadDashboard();
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        });

        async function loadAttendance() {
            const atts = await window.supabaseHelpers.getAttendanceHistory(currentDoc.id);
            const tbody = document.getElementById('att-table-body');
            tbody.innerHTML = '';
            
            atts.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${a.date}</td>
                    <td class="p-2 text-green-600">${new Date(a.check_in).toLocaleTimeString('ar-EG')}</td>
                    <td class="p-2 text-red-600">${a.check_out ? new Date(a.check_out).toLocaleTimeString('ar-EG') : '-'}</td>
                    <td class="p-2 font-mono">${a.total_hours || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function checkInAction() {
            const res = await window.supabaseHelpers.checkIn(currentDoc.id);
            if(res) { alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±'); loadAttendance(); }
        }
        
        async function checkOutAction() {
            const atts = await window.supabaseHelpers.getAttendanceHistory(currentDoc.id);
            if(atts.length > 0 && !atts[0].check_out) {
                await window.supabaseHelpers.checkOut(atts[0].id);
                alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù');
                loadAttendance();
            } else {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù…ÙØªÙˆØ­ Ø§Ù„ÙŠÙˆÙ…');
            }
        }

        async function loadLeaves() {
            const leaves = await window.supabaseHelpers.getDoctorLeaves(currentDoc.id);
            const tbody = document.getElementById('leaves-table-body');
            tbody.innerHTML = '';
            
            leaves.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">${l.leave_type}</td>
                    <td class="p-3">${l.start_date}</td>
                    <td class="p-3">${l.end_date}</td>
                    <td class="p-3 badge">${l.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('leave-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                doctor_id: currentDoc.id,
                leave_type: document.getElementById('leave-type').value,
                start_date: document.getElementById('leave-start').value,
                end_date: document.getElementById('leave-end').value,
                status: 'pending'
            };
            await window.supabaseHelpers.addLeaveRequest(data);
            alert('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨');
            loadLeaves();
        });

        function logout() {
            localStorage.removeItem('doctor');
            location.reload();
        }

        const saved = localStorage.getItem('doctor');
        if(saved) {
            currentDoc = JSON.parse(saved);
            showPortal();
        }
    </script>
</body>
</html>
