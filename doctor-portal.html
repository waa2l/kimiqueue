<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ø§Ø¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'arabic': ['Cairo', 'sans-serif'] },
                    colors: {
                        'primary': '#1e40af',
                        'secondary': '#3b82f6',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-50 font-arabic">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold text-primary">ğŸ¥ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h1>
                <a href="index.html" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="login-modal" class="modal show">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h2>
                <p class="text-gray-600">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="doctor-email" value="ahmed@clinic.com" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="doctor-password" value="doctor123" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-secondary">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </form>
        </div>
    </div>

    <!-- Main Portal -->
    <div id="doctor-portal" class="hidden">
        <div class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div>
                            <h1 id="doctor-name" class="text-2xl font-bold text-gray-900"></h1>
                            <p id="doctor-specialty" class="text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-success" id="attendance-status">--</div>
                            <div class="text-sm text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                        </div>
                        <button onclick="logoutDoctor()" class="bg-danger text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            <i class="fas fa-sign-out-alt ml-2"></i>Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <!-- Today's Schedule -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</h2>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="checkIn()" id="check-in-btn" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                    <i class="fas fa-clock ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±
                                </button>
                                <button onclick="checkOut()" id="check-out-btn" class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-yellow-600" style="display:none">
                                    <i class="fas fa-sign-out-alt ml-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3" id="today-schedule">
                            <p class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>

                    <!-- Consultations -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
                            <span class="bg-danger text-white px-2 py-1 rounded text-sm" id="consultations-count">0</span>
                        </div>
                        <div class="space-y-4" id="consultations-list">
                            <p class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>

                    <!-- Leave Requests -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</h2>
                            <button onclick="openLeaveRequestModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary">
                                <i class="fas fa-plus ml-2"></i>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                        <div class="space-y-3" id="leave-requests">
                            <p class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Profile -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="text-center mb-4">
                            <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center text-white text-3xl mx-auto mb-3">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <h3 class="font-semibold" id="profile-name"></h3>
                            <p class="text-sm text-gray-600" id="profile-specialty"></p>
                        </div>
                        <div class="space-y-3" id="profile-info">
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</span>
                                <span class="font-semibold text-success" id="stat-consultations">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</span>
                                <span class="font-semibold text-secondary" id="stat-hours">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</span>
                                <span class="font-medium" id="check-in-time">--:--</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Ø¢Ø®Ø± Ø®Ø±ÙˆØ¬</span>
                                <span class="font-medium" id="check-out-time">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Request Modal -->
    <div id="leave-request-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯</h3>
                <button onclick="closeLeaveRequestModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="leave-request-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
                    <select id="leave-type" class="w-full px-3 py-2 border rounded-lg" required>
                        <option value="annual">Ø¥Ø¬Ø§Ø²Ø© Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©</option>
                        <option value="sick">Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©</option>
                        <option value="emergency">Ø¥Ø¬Ø§Ø²Ø© Ø¹Ø§Ø±Ø¶Ø©</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="leave-start" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="leave-end" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø³Ø¨Ø¨/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="leave-notes" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div class="flex space-x-3 space-x-reverse">
                    <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-secondary">Ø¥Ø±Ø³Ø§Ù„</button>
                    <button type="button" onclick="closeLeaveRequestModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Consultation Reply Modal -->
    <div id="reply-modal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</h3>
                <button onclick="closeReplyModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="consultation-details" class="mb-4 p-4 bg-gray-50 rounded-lg"></div>
            <form id="reply-form">
                <input type="hidden" id="reply-consultation-id">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠ</label>
                    <textarea id="doctor-response" rows="5" class="w-full px-3 py-2 border rounded-lg" required></textarea>
                </div>
                <div class="flex space-x-3 space-x-reverse">
                    <button type="submit" class="flex-1 bg-success text-white py-2 rounded-lg hover:bg-green-600">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
                    <button type="button" onclick="closeReplyModal()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        let currentDoctor = null;
        let currentAttendanceId = null;

        function checkSupabaseReady() {
            return new Promise((resolve) => {
                if (window.supabaseHelpers) resolve();
                else setTimeout(() => checkSupabaseReady().then(resolve), 100);
            });
        }

        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await checkSupabaseReady();
            
            const email = document.getElementById('doctor-email').value;
            const password = document.getElementById('doctor-password').value;
            
            const doctors = await window.supabaseHelpers.getDoctors();
            const doctor = doctors.find(d => d.email === email && d.password === password);
            
            if (doctor) {
                currentDoctor = doctor;
                localStorage.setItem('currentDoctor', JSON.stringify(doctor));
                initializeDoctorPortal();
            } else {
                alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        });

        async function initializeDoctorPortal() {
            document.getElementById('login-modal').classList.remove('show');
            document.getElementById('doctor-portal').classList.remove('hidden');
            
            document.getElementById('doctor-name').textContent = currentDoctor.name;
            document.getElementById('doctor-specialty').textContent = `${currentDoctor.specialty} - ${currentDoctor.clinic}`;
            document.getElementById('profile-name').textContent = currentDoctor.name;
            document.getElementById('profile-specialty').textContent = currentDoctor.specialty;
            
            const profileInfo = document.getElementById('profile-info');
            profileInfo.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</span>
                    <span class="font-medium">${currentDoctor.clinic}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                    <span class="font-medium text-success">${currentDoctor.status === 'active' ? 'Ù†Ø´Ø·' : 'ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©'}</span>
                </div>
            `;
            
            await loadConsultations();
            await loadLeaveRequests();
            await loadTodayAppointments();
            checkTodayAttendance();
        }

        async function loadConsultations() {
            const consultations = await window.supabaseHelpers.getConsultations('pending');
            const myConsultations = consultations.filter(c => c.specialty === currentDoctor.specialty);
            
            document.getElementById('consultations-count').textContent = myConsultations.length;
            document.getElementById('stat-consultations').textContent = myConsultations.length;
            
            const container = document.getElementById('consultations-list');
            container.innerHTML = '';
            
            if (myConsultations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
                return;
            }
            
            myConsultations.forEach(consultation => {
                const div = document.createElement('div');
                div.className = 'border rounded-lg p-4';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold">${consultation.patient_name}</h3>
                            <p class="text-sm text-gray-600">${consultation.specialty}</p>
                        </div>
                        <span class="text-xs text-gray-500">${new Date(consultation.created_at).toLocaleString('ar-EG')}</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-3">${consultation.complaint}</p>
                    <button onclick="openReplyModal(${consultation.id}, '${consultation.patient_name}', '${consultation.complaint}')" class="bg-primary text-white px-3 py-1 rounded text-sm hover:bg-secondary">
                        <i class="fas fa-reply ml-1"></i>Ø§Ù„Ø±Ø¯
                    </button>
                `;
                container.appendChild(div);
            });
        }

        async function loadLeaveRequests() {
            const requests = await window.supabaseHelpers.getLeaveRequests(currentDoctor.id);
            
            const container = document.getElementById('leave-requests');
            container.innerHTML = '';
            
            if (requests.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
                return;
            }
            
            requests.slice(0, 5).forEach(request => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                const statusColor = request.status === 'approved' ? 'text-success' : request.status === 'rejected' ? 'text-danger' : 'text-warning';
                const statusText = request.status === 'approved' ? 'Ù…Ø¹ØªÙ…Ø¯' : request.status === 'rejected' ? 'Ù…Ø±ÙÙˆØ¶' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${request.leave_type}</div>
                        <div class="text-sm text-gray-600">${request.start_date} Ø¥Ù„Ù‰ ${request.end_date}</div>
                    </div>
                    <span class="text-sm font-medium ${statusColor}">${statusText}</span>
                `;
                container.appendChild(div);
            });
        }

        async function loadTodayAppointments() {
            const today = new Date().toISOString().split('T')[0];
            const appointments = await window.supabaseHelpers.getAppointments(today);
            const myAppointments = appointments.filter(a => a.doctor_id === currentDoctor.id);
            
            const container = document.getElementById('today-schedule');
            container.innerHTML = '';
            
            if (myAppointments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</p>';
                return;
            }
            
            myAppointments.forEach(apt => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${apt.patient_name}</div>
                        <div class="text-sm text-gray-600">${apt.visit_reason || 'ÙØ­Øµ Ø±ÙˆØªÙŠÙ†ÙŠ'}</div>
                    </div>
                    <div class="text-sm text-primary font-semibold">${apt.appointment_time?.substring(0, 5)}</div>
                `;
                container.appendChild(div);
            });
        }

        async function checkTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const records = await window.supabaseHelpers.getAttendance(currentDoctor.id, today);
            
            if (records.length > 0 && records[0].check_in) {
                const record = records[0];
                currentAttendanceId = record.id;
                document.getElementById('check-in-time').textContent = new Date(record.check_in).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                document.getElementById('attendance-status').textContent = 'Ø­Ø§Ø¶Ø±';
                document.getElementById('check-in-btn').style.display = 'none';
                document.getElementById('check-out-btn').style.display = 'block';
                
                if (record.check_out) {
                    document.getElementById('check-out-time').textContent = new Date(record.check_out).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                    document.getElementById('check-out-btn').style.display = 'none';
                }
            }
        }

        async function checkIn() {
            const result = await window.supabaseHelpers.checkIn(currentDoctor.id);
            if (result) {
                currentAttendanceId = result.id;
                document.getElementById('check-in-time').textContent = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                document.getElementById('attendance-status').textContent = 'Ø­Ø§Ø¶Ø±';
                document.getElementById('check-in-btn').style.display = 'none';
                document.getElementById('check-out-btn').style.display = 'block';
                alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        async function checkOut() {
            if (currentAttendanceId) {
                const result = await window.supabaseHelpers.checkOut(currentAttendanceId);
                if (result) {
                    document.getElementById('check-out-time').textContent = new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                    document.getElementById('check-out-btn').style.display = 'none';
                    alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ù†Ø¬Ø§Ø­');
                }
            }
        }

        function openReplyModal(consultationId, patientName, complaint) {
            document.getElementById('reply-consultation-id').value = consultationId;
            document.getElementById('consultation-details').innerHTML = `
                <div class="font-semibold mb-2">Ø§Ù„Ù…Ø±ÙŠØ¶: ${patientName}</div>
                <div class="text-sm text-gray-600">Ø§Ù„Ø´ÙƒÙˆÙ‰: ${complaint}</div>
            `;
            document.getElementById('reply-modal').classList.add('show');
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('show');
            document.getElementById('reply-form').reset();
        }

        document.getElementById('reply-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const consultationId = document.getElementById('reply-consultation-id').value;
            const response = document.getElementById('doctor-response').value;
            
            const result = await window.supabaseHelpers.updateConsultation(consultationId, {
                doctor_response: response,
                doctor_id: currentDoctor.id,
                status: 'completed'
            });
            
            if (result) {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                closeReplyModal();
                await loadConsultations();
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            }
        });

        function openLeaveRequestModal() {
            document.getElementById('leave-request-modal').classList.add('show');
        }

        function closeLeaveRequestModal() {
            document.getElementById('leave-request-modal').classList.remove('show');
            document.getElementById('leave-request-form').reset();
        }

        document.getElementById('leave-request-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const leaveData = {
                doctor_id: currentDoctor.id,
                leave_type: document.getElementById('leave-type').value,
                start_date: document.getElementById('leave-start').value,
                end_date: document.getElementById('leave-end').value,
                notes: document.getElementById('leave-notes').value
            };
            
            const result = await window.supabaseHelpers.addLeaveRequest(leaveData);
            
            if (result) {
                alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                closeLeaveRequestModal();
                await loadLeaveRequests();
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            }
        });

        function logoutDoctor() {
            localStorage.removeItem('currentDoctor');
            location.reload();
        }

        // Check if already logged in
        const savedDoctor = localStorage.getItem('currentDoctor');
        if (savedDoctor) {
            currentDoctor = JSON.parse(savedDoctor);
            initializeDoctorPortal();
        }
    </script>
</body>
</html>
