<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .nav-item { cursor: pointer; padding: 10px 20px; border-radius: 8px; transition: all 0.2s; color: #4b5563; }
        .nav-item:hover { background-color: #e5e7eb; }
        .nav-item.active { background-color: #1e40af; color: white; font-weight: bold; }
        .content-section { display: none; }
        .content-section.active { display: block; }
    </style>
</head>
<body>

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-primary">ğŸ‘¨â€âš•ï¸ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</h1>
                <span id="doc-name" class="text-sm bg-blue-50 text-blue-700 px-3 py-1 rounded-full"></span>
            </div>
            <button onclick="logout()" class="text-red-500 hover:text-red-700 font-medium">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-gray-900/50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h2>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-3 border rounded" required>
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 border rounded" required>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded font-bold hover:bg-blue-700">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <div id="portal-content" class="max-w-7xl mx-auto px-4 py-8 hidden">
        
        <div class="flex flex-wrap gap-2 mb-6 bg-white p-2 rounded-lg shadow-sm">
            <div onclick="switchTab('dashboard')" id="tab-dashboard" class="nav-item active">
                <i class="fas fa-inbox ml-2"></i>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
            </div>
            <div onclick="switchTab('history')" id="tab-history" class="nav-item">
                <i class="fas fa-history ml-2"></i>Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯
            </div>
            <div onclick="switchTab('attendance')" id="tab-attendance" class="nav-item">
                <i class="fas fa-clock ml-2"></i>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù
            </div>
            <div onclick="switchTab('leaves')" id="tab-leaves" class="nav-item">
                <i class="fas fa-calendar-minus ml-2"></i>Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª
            </div>
        </div>

        <div id="sec-dashboard" class="content-section active">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù…ÙØªÙˆØ­Ø© (ØªØ®ØµØµÙƒ)
                </h2>
                <div id="pending-list" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </div>

        <div id="sec-history" class="content-section">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4 text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ Ø±Ø¯Ø¯Øª Ø¹Ù„ÙŠÙ‡Ø§</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 text-gray-700">
                            <tr>
                                <th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</th>
                                <th class="p-3">Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                                <th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯</th>
                                <th class="p-3">Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø¯</th>
                                <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-attendance" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <h3 class="font-bold text-gray-700 mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="space-y-3">
                        <button onclick="checkInAction()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
                        <button onclick="checkOutAction()" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù</button>
                    </div>
                    <p id="att-status" class="mt-3 text-sm text-gray-500"></p>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-gray-700 mb-4">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                    <div class="overflow-y-auto max-h-64">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-2">Ø¯Ø®ÙˆÙ„</th>
                                    <th class="p-2">Ø®Ø±ÙˆØ¬</th>
                                    <th class="p-2">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="att-table-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-leaves" class="content-section">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="font-bold mb-4">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯</h3>
                <form id="leave-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="text-xs block mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select id="leave-type" class="w-full p-2 border rounded">
                            <option>Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©</option>
                            <option>Ù…Ø±Ø¶ÙŠØ©</option>
                            <option>Ø¹Ø§Ø±Ø¶Ø©</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs block mb-1">Ù…Ù†</label>
                        <input type="date" id="leave-start" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="text-xs block mb-1">Ø¥Ù„Ù‰</label>
                        <input type="date" id="leave-end" class="w-full p-2 border rounded" required>
                    </div>
                    <button type="submit" class="bg-primary text-white py-2 rounded">ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨</button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-bold mb-4">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
                <table class="w-full text-sm text-right">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th class="p-3">Ù…Ù†</th>
                            <th class="p-3">Ø¥Ù„Ù‰</th>
                            <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="leaves-table-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="reply-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between">
                <h3 class="font-bold text-lg">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©</h3>
                <button onclick="closeModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-gray-50 space-y-4">
                <div class="bg-white p-4 rounded shadow-sm">
                    <h4 class="font-bold text-gray-800" id="m-patient"></h4>
                    <p class="text-sm text-gray-500" id="m-info"></p>
                </div>
                <div class="bg-white p-4 rounded shadow-sm border-l-4 border-blue-500">
                    <span class="text-xs text-gray-400">Ø§Ù„Ø´ÙƒÙˆÙ‰:</span>
                    <p class="text-gray-800 mt-1" id="m-complaint"></p>
                </div>
                <div class="bg-white p-4 rounded shadow-sm">
                    <span class="text-xs text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ:</span>
                    <div id="m-medical" class="text-sm mt-1 text-red-600"></div>
                </div>
                
                <textarea id="reply-text" rows="4" class="w-full p-3 border rounded focus:ring-2 focus:ring-primary" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø¹Ù„Ø§Ø¬..."></textarea>
            </div>
            <div class="p-4 border-t flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="submitReply()" class="px-6 py-2 bg-primary text-white rounded">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
            </div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        let currentDoc = null;
        let selectedConsultationId = null;

        function checkReady() { return new Promise(r => window.supabaseHelpers ? r() : setTimeout(() => checkReady().then(r), 100)); }

        // --- Auth & Init ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await checkReady();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            const docs = await window.supabaseHelpers.getDoctors();
            const doc = docs.find(d => d.email === email && d.password === pass);

            if(doc) {
                currentDoc = doc;
                localStorage.setItem('doctor', JSON.stringify(doc));
                showPortal();
            } else {
                alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©');
            }
        });

        function showPortal() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('portal-content').classList.remove('hidden');
            document.getElementById('doc-name').textContent = `Ø¯. ${currentDoc.name} (${currentDoc.specialty})`;
            loadDashboard();
        }

        // --- Tabs Logic ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`sec-${tab}`).classList.add('active');

            if(tab === 'dashboard') loadDashboard();
            if(tab === 'history') loadHistory();
            if(tab === 'attendance') loadAttendance();
            if(tab === 'leaves') loadLeaves();
        }

        // --- 1. Dashboard (Pending) ---
        async function loadDashboard() {
            const list = document.getElementById('pending-list');
            list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            
            const consultations = await window.supabaseHelpers.getPendingConsultationsBySpecialty(currentDoc.specialty);
            
            if(consultations.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
                return;
            }

            list.innerHTML = '';
            consultations.forEach(c => {
                const div = document.createElement('div');
                div.className = 'bg-white border rounded p-4 flex justify-between items-center hover:shadow-md transition';
                div.innerHTML = `
                    <div>
                        <h4 class="font-bold">${c.patient_name}</h4>
                        <p class="text-sm text-gray-500 truncate w-64">${c.complaint}</p>
                        <span class="text-xs text-gray-400">${new Date(c.created_at).toLocaleDateString('ar-EG')}</span>
                    </div>
                    <button onclick="openReply('${c.id}')" class="bg-blue-100 text-blue-700 px-4 py-2 rounded text-sm hover:bg-blue-200">Ø±Ø¯</button>
                `;
                list.appendChild(div);
            });
        }

        // --- 2. History ---
        async function loadHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">...</td></tr>';
            
            const history = await window.supabaseHelpers.getDoctorHistory(currentDoc.id);
            tbody.innerHTML = '';

            history.forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 font-mono text-gray-500">${h.consultation_number || '-'}</td>
                    <td class="p-3 font-bold">${h.patient_name}</td>
                    <td class="p-3">${new Date(h.updated_at).toLocaleDateString('ar-EG')}</td>
                    <td class="p-3 text-gray-500 truncate max-w-xs">${h.doctor_reply || ''}</td>
                    <td class="p-3"><span class="bg-green-100 text-green-700 px-2 rounded text-xs">Ù…ÙƒØªÙ…Ù„Ø©</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Reply Logic ---
        let currentConsultation = null;
        async function openReply(id) {
            const all = await window.supabaseHelpers.getPendingConsultationsBySpecialty(currentDoc.specialty);
            currentConsultation = all.find(c => c.id == id);
            
            document.getElementById('m-patient').textContent = currentConsultation.patient_name;
            document.getElementById('m-info').textContent = `${currentConsultation.gender} | ${currentConsultation.phone}`;
            document.getElementById('m-complaint').textContent = currentConsultation.complaint;
            
            // Format Medical History
            let medical = [];
            if(currentConsultation.chronic_diseases) medical.push(`Ù…Ø²Ù…Ù†Ø©: ${JSON.stringify(currentConsultation.chronic_diseases)}`);
            if(currentConsultation.surgeries) medical.push(`Ø¹Ù…Ù„ÙŠØ§Øª: ${currentConsultation.surgery_notes}`);
            if(currentConsultation.allergies) medical.push(`Ø­Ø³Ø§Ø³ÙŠØ©: ${currentConsultation.allergy_notes}`);
            document.getElementById('m-medical').textContent = medical.join(' | ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® Ù…Ø±Ø¶ÙŠ Ù…Ù‡Ù…';

            document.getElementById('reply-modal').classList.remove('hidden');
            document.getElementById('reply-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('reply-modal').classList.add('hidden');
            document.getElementById('reply-modal').classList.remove('flex');
        }

        async function submitReply() {
            const reply = document.getElementById('reply-text').value;
            if(!reply) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯');

            await window.supabaseHelpers.updateConsultation(currentConsultation.id, {
                doctor_reply: reply,
                doctor_id: currentDoc.id,
                status: 'completed',
                updated_at: new Date().toISOString()
            });

            alert('ØªÙ… Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            closeModal();
            loadDashboard(); // Refresh
        }

        // --- 3. Attendance ---
        async function loadAttendance() {
            const atts = await window.supabaseHelpers.getAttendanceHistory(currentDoc.id);
            const tbody = document.getElementById('att-table-body');
            tbody.innerHTML = '';
            
            atts.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${a.date}</td>
                    <td class="p-2 text-green-600">${new Date(a.check_in).toLocaleTimeString('ar-EG')}</td>
                    <td class="p-2 text-red-600">${a.check_out ? new Date(a.check_out).toLocaleTimeString('ar-EG') : '-'}</td>
                    <td class="p-2 font-mono">${a.total_hours || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function checkInAction() {
            const res = await window.supabaseHelpers.checkIn(currentDoc.id);
            if(res) { alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±'); loadAttendance(); }
        }
        
        // This assumes last record is today's check-in
        async function checkOutAction() {
            const atts = await window.supabaseHelpers.getAttendanceHistory(currentDoc.id);
            if(atts.length > 0 && !atts[0].check_out) {
                await window.supabaseHelpers.checkOut(atts[0].id);
                alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù');
                loadAttendance();
            } else {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù…ÙØªÙˆØ­ Ø§Ù„ÙŠÙˆÙ…');
            }
        }

        // --- 4. Leaves ---
        async function loadLeaves() {
            const leaves = await window.supabaseHelpers.getDoctorLeaves(currentDoc.id);
            const tbody = document.getElementById('leaves-table-body');
            tbody.innerHTML = '';
            
            leaves.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">${l.type}</td>
                    <td class="p-3">${l.start_date}</td>
                    <td class="p-3">${l.end_date}</td>
                    <td class="p-3 badge">${l.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('leave-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                doctor_id: currentDoc.id,
                type: document.getElementById('leave-type').value,
                start_date: document.getElementById('leave-start').value,
                end_date: document.getElementById('leave-end').value,
                status: 'pending'
            };
            await window.supabaseHelpers.addLeaveRequest(data);
            alert('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨');
            loadLeaves();
        });

        function logout() {
            localStorage.removeItem('doctor');
            location.reload();
        }

        // Init
        const saved = localStorage.getItem('doctor');
        if(saved) {
            currentDoc = JSON.parse(saved);
            showPortal();
        }
    </script>
</body>
</html>
